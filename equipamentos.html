<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SIPAT-LJ - Equipamentos</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />

  <style>
    :root{
      --bg:#0d1117;
      --panel:#10141c;
      --card:#1a1d2e;
      --neon:#00ff88;
      --muted:#bfc5c2;
    }

    *{box-sizing:border-box;}

    body{
      margin:0;
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto;
      background: linear-gradient(135deg,var(--bg), #1b1f27);
      color:#fff;
      min-height:100vh;
      padding:28px 18px;
      display:flex;
      flex-direction:column;
      align-items:center;
    }

    header.pill-navbar {
      display:flex;
      justify-content:space-between;
      align-items:center;
      background:#161b22;
      padding:14px 32px;
      margin:0 auto 22px auto;
      border-radius:50px;
      max-width:1100px;
      width:100%;
      border:1px solid var(--neon);
    }

    .logo{
      font-size:1.5rem;
      font-weight:700;
      color:var(--neon);
    }

    .nav-links{
      display:flex;
      gap:12px;
      align-items:center;
    }

    .nav-links a{
      padding:8px 20px;
      text-decoration:none;
      font-weight:500;
      background:#1f2630;
      color:#ccc;
      border-radius:30px;
      transition:.3s;
    }

    .nav-links a:hover,
    .nav-links a.active{
      background:var(--neon);
      color:#000;
    }

    .profile-pic{
      width:42px;
      height:42px;
      border-radius:50%;
      object-fit:cover;
      cursor:pointer;
      transition:.2s;
    }

    .profile-pic:hover{
      transform:scale(1.05);
    }

    .container{width:100%;max-width:1100px;}

    .section{
      background:var(--panel);
      padding:26px;
      border-radius:14px;
      border:1px solid rgba(0,255,136,0.06);
    }

    h2{
      color:var(--neon);
      margin:0 0 18px;
      border-bottom:2px solid rgba(0,255,136,0.06);
      padding-bottom:10px;
    }

    .action-buttons{
      display:flex;
      justify-content:flex-start;
      margin-bottom:15px;
      gap:10px;
      flex-wrap:wrap;
    }

    .accordion-item{
      margin-bottom:12px;
      background:var(--card);
      border-radius:10px;
      overflow:hidden;
      border:1px solid rgba(0,255,136,0.04);
      transition:transform 0.25s ease;
    }

    .accordion-item:hover{
      transform: translateY(-1px);
    }

    .accordion-header{
      padding:14px 18px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      cursor:pointer;
      color:var(--neon);
      font-weight:600;
      transition:background .25s ease, color .25s ease;
    }

    .accordion-header:hover{
      background:rgba(0,255,136,0.08);
    }

    .accordion-header::after{
      content:'+';
      font-size:20px;
      transition:transform 0.3s ease, color 0.3s ease;
    }

    .accordion-header.active::after{
      content:'−';
      transform:rotate(180deg);
      color:var(--neon);
    }

    .accordion-content{
      max-height:0;
      overflow:hidden;
      opacity:0;
      transform:translateY(-10px);
      transition: max-height 0.5s ease, opacity 0.4s ease, transform 0.4s ease, padding 0.4s ease;
      padding:0 18px;
    }

    .accordion-content.open{
      max-height:1000px;
      padding:12px 18px 18px 18px;
      opacity:1;
      transform:translateY(0);
    }

    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{
      padding:10px;
      border-bottom:1px solid #23272f;
      color:#ddd;
      text-align:left;
      font-size:14px;
    }
    th{color:var(--neon)}

    .btn-detalhar{
      background:var(--neon);
      color:#000;
      border:none;
      padding:8px 12px;
      border-radius:8px;
      cursor:pointer;
      font-weight:600;
      transition:background .25s;
    }

    .btn-detalhar:hover{
      background:#00cc6a;
    }

    .modal-bg{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background: rgba(0,0,0,0.6);
      backdrop-filter: blur(4px);
      z-index:9999;
    }

    .modal{
      width:420px;
      max-width:94%;
      background:#161b22;
      border-radius:12px;
      padding:20px;
      border:1px solid var(--neon);
    }

    .modal h3{margin:0 0 12px;color:var(--neon)}
    .modal input, .modal select{
      width:100%;
      padding:8px;
      margin-top:6px;
      border-radius:6px;
      border:1px solid #ccc;
      background:#0d1117;
      color:#fff;
    }

    .modal p{margin:8px 0; color:#dfe6df; font-size:14px}
    .modal .close{
      margin-top:14px;background:#ff5555;color:#fff;
      border:none;padding:8px 12px;border-radius:8px;cursor:pointer
    }
  </style>
</head>

<body>
  <header class="pill-navbar">
    <div class="logo">SIPAT-LJ</div>
    <nav class="nav-links" id="navLinks"></nav>
  </header>

  <div class="container">
    <section class="section">
      <h2>Todos os Equipamentos por Setor</h2>

      <div class="action-buttons" id="actionButtons">
        <button id="btnAddEquip" class="btn-detalhar">Adicionar Equipamento</button>
        <button id="btnAddSetor" class="btn-detalhar">Adicionar Setor</button>
      </div>

      <div id="accordionContainer"></div>
    </section>
  </div>

  <!-- Modal Adicionar Setor -->
  <div class="modal-bg" id="modalSetor">
    <div class="modal">
      <h3>Adicionar Setor</h3>
      <input type="text" id="nomeSetorInput" placeholder="Nome do Setor" />
      <button id="salvarSetor" class="btn-detalhar">Salvar</button>
      <button class="close" onclick="closeModal('modalSetor')">Fechar</button>
    </div>
  </div>

  <!-- Modal Adicionar Equipamento -->
  <div class="modal-bg" id="modalEquip">
    <div class="modal">
      <h3>Adicionar Equipamento</h3>
      <input type="text" id="tomboInput" placeholder="Tombo" />
      <input type="text" id="descricaoInput" placeholder="Descrição" />
      <input type="text" id="setorInput" placeholder="Setor" />
      <button id="salvarEquip" class="btn-detalhar">Salvar</button>
      <button class="close" onclick="closeModal('modalEquip')">Fechar</button>
    </div>
  </div>

  <script>
    const API_URL = "http://localhost:5000";

    // ----- HEADER DINÂMICO -----
    const tipo = localStorage.getItem("tipoUsuario"); // 'aluno' ou 'servidor'
    const nav = document.getElementById("navLinks");
    const fotoSalva = localStorage.getItem("fotoPerfil");

    if (tipo === "servidor") {
      nav.innerHTML = `
        <a href="index.html">Início</a>
        <a class="active">Equipamentos</a>
        <a href="relatar.html">Relatar</a>
        <a href="admin.html">Denúncias</a>
        <a href="confi.html">
          <img src="${fotoSalva || 'perfil_padrao.png'}" class="profile-pic" alt="Perfil" />
        </a>
      `;
    } else {
      nav.innerHTML = `
        <a href="index.html">Início</a>
        <a class="active">Equipamentos</a>
        <a href="relatar.html">Relatar</a>
        <a href="confi.html">
          <img src="${fotoSalva || 'perfil_padrao.png'}" class="profile-pic" alt="Perfil" />
        </a>
      `;
    }

    async function fetchSetores() {
      const res = await fetch(`${API_URL}/setores`);
      const data = await res.json();
      return data.Setores || [];
    }

    async function fetchPatrimonio() {
      const res = await fetch(`${API_URL}/patrimonio`);
      const data = await res.json();
      return data.patrimonio_completo || [];
    }

    function createAccordionItem(setor, equipamentos) {
      const item = document.createElement('div');
      item.classList.add('accordion-item');

      const header = document.createElement('div');
      header.classList.add('accordion-header');
      header.textContent = setor.nome_setor;

      const content = document.createElement('div');
      content.classList.add('accordion-content');

      const table = document.createElement('table');
      const thead = document.createElement('thead');
      thead.innerHTML = `<tr>
          <th>Tombo</th>
          <th>Descrição</th>
          <th>Situação</th>
          <th>Local</th>
        </tr>`;
      table.appendChild(thead);

      const tbody = document.createElement('tbody');
      equipamentos.forEach(eq => {
        if(eq.setor === setor.nome_setor){
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${eq.tombo}</td>
                          <td>${eq.descricao}</td>
                          <td>${eq.situacao}</td>
                          <td>${eq.local}</td>`;
          tbody.appendChild(tr);
        }
      });
      table.appendChild(tbody);
      content.appendChild(table);

      header.addEventListener('click', () => {
        header.classList.toggle('active');
        content.classList.toggle('open');
      });

      item.appendChild(header);
      item.appendChild(content);
      return item;
    }

    async function loadAccordion() {
      const container = document.getElementById('accordionContainer');
      container.innerHTML = '';
      const setores = await fetchSetores();
      const patrimonio = await fetchPatrimonio();

      setores.forEach(setor => {
        const eqs = patrimonio.filter(p => p.setor === setor.nome_setor);
        const item = createAccordionItem(setor, eqs);
        container.appendChild(item);
      });
    }

    function openModal(id) { document.getElementById(id).style.display = 'flex'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }

    document.getElementById('btnAddSetor').addEventListener('click', () => openModal('modalSetor'));
    document.getElementById('btnAddEquip').addEventListener('click', () => openModal('modalEquip'));

    document.getElementById('salvarSetor').addEventListener('click', async () => {
      const nomeSetor = document.getElementById('nomeSetorInput').value.trim();
      if(!nomeSetor) return alert("Digite o nome do setor!");
      const res = await fetch(`${API_URL}/addsetor`, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({Setor: nomeSetor})
      });
      if(res.ok){
        alert("Setor adicionado com sucesso!");
        closeModal('modalSetor');
        loadAccordion();
        document.getElementById('nomeSetorInput').value = '';
      } else {
        const err = await res.json();
        alert(err.message || "Erro ao adicionar setor");
      }
    });

    document.getElementById('salvarEquip').addEventListener('click', async () => {
      const tombo = document.getElementById('tomboInput').value.trim();
      const descricao = document.getElementById('descricaoInput').value.trim();
      const setor = document.getElementById('setorInput').value.trim();

      if(!tombo || !descricao || !setor) return alert("Preencha todos os campos!");
      const res = await fetch(`${API_URL}/insobj`, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({
          Tombo: tombo,
          Descrição: descricao,
          Setor: setor
        })
      });
      if(res.ok){
        alert("Equipamento adicionado com sucesso!");
        closeModal('modalEquip');
        loadAccordion();
        document.getElementById('tomboInput').value = '';
        document.getElementById('descricaoInput').value = '';
        document.getElementById('setorInput').value = '';
      } else {
        const err = await res.json();
        alert(err.message || "Erro ao adicionar equipamento");
      }
    });

    loadAccordion();
  </script>
</body>
</html>
